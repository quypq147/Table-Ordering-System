@page "/chat"
@using WaiterApp.Services
@inject OrdersRealtimeService Realtime
@inject ApiClient ApiClient

<div class="container py-3">
    <h4 class="mb-3">Chat với khách</h4>

    @if (!connected)
    {
        <div class="alert alert-warning">
            Đang kết nối đến server chat...
        </div>
    }

    <div class="card shadow-sm">
        <div class="card-body d-flex flex-column" style="max-height: 60vh;">
            <div class="messages overflow-auto mb-3" style="flex:1 1 auto;" @ref="messagesContainer">
                @if (messages.Count == 0)
                {
                    <div class="text-muted small">Chưa có tin nhắn nào.</div>
                }
                else
                {
                    @foreach (var m in messages.OrderBy(m => m.SentAtUtc))
                    {
                        var isStaff = string.Equals(m.Sender, "staff", StringComparison.OrdinalIgnoreCase) || m.Sender == "Tôi";
                        <div class="d-flex mb-2 @(isStaff ? "justify-content-end" : "justify-content-start")">
                            <div class="chat-bubble @(isStaff ? "chat-bubble-right" : "chat-bubble-left")">
                                <div class="small text-muted mb-1">
                                    @(isStaff ? "Bạn" : $"Bàn {m.TableId} - {m.Sender}")
                                    <span class="ms-1">@m.SentAtLocal.ToString("HH:mm")</span>
                                </div>
                                <div>@m.Message</div>
                            </div>
                        </div>
                    }
                }
            </div>

            <div class="d-flex gap-2 mt-2" style="flex:0 0 auto;">
                <input class="form-control" placeholder="Nhập tin nhắn..." @bind="outgoing" @bind:event="oninput" @onkeydown="OnKeyDown" />
                <button class="btn btn-primary" @onclick="SendAsync" disabled="@string.IsNullOrWhiteSpace(outgoing)">Gửi</button>
            </div>
        </div>
    </div>
</div>

@code {
    private readonly List<ChatMessageViewModel> messages = new();
    private bool connected;
    private ElementReference messagesContainer;
    private string outgoing = string.Empty;
    private string? currentTableId;

    protected override async Task OnInitializedAsync()
    {
        Realtime.ChatMessageReceived += OnChatMessageReceived;

        if (!Realtime.IsConnected)
        {
            try
            {
                await Realtime.StartAsync();
                connected = Realtime.IsConnected;
            }
            catch (Exception ex)
            {
                connected = false;
                Console.Error.WriteLine(ex.ToString());
            }
        }
        else
        {
            connected = true;
        }
    }

    private async void OnChatMessageReceived(ChatMessagePayload payload)
    {
        var vm = new ChatMessageViewModel
        {
            TableId = payload.TableId,
            Sender = string.IsNullOrWhiteSpace(payload.Sender) ? "Khách" : payload.Sender,
            Message = payload.Message,
            SentAtUtc = payload.SentAtUtc
        };

        currentTableId = payload.TableId; // set last active table for reply
        messages.Add(vm);
        await InvokeAsync(async () =>
        {
            StateHasChanged();
            await Task.Delay(30);
            await ScrollToBottomAsync();
        });
    }

    public void Dispose()
    {
        Realtime.ChatMessageReceived -= OnChatMessageReceived;
    }

    private async Task SendAsync()
    {
        if (string.IsNullOrWhiteSpace(outgoing)) return;
        if (string.IsNullOrWhiteSpace(currentTableId))
        {
            Console.Error.WriteLine("No table selected to send chat.");
            return;
        }

        try
        {
            var body = new { TableCode = currentTableId, Sender = "staff", Message = outgoing };
            var resp = await ApiClient.Http.PostAsJsonAsync("api/chat", body);
            if (!resp.IsSuccessStatusCode)
            {
                Console.Error.WriteLine("Chat send failed: " + resp.ReasonPhrase);
            }
            else
            {
                messages.Add(new ChatMessageViewModel
                {
                    TableId = currentTableId,
                    Sender = "Tôi",
                    Message = outgoing,
                    SentAtUtc = DateTime.UtcNow
                });
                outgoing = string.Empty;
                await InvokeAsync(StateHasChanged);
                await ScrollToBottomAsync();
            }
        }
        catch (Exception ex)
        {
            Console.Error.WriteLine(ex.ToString());
        }
    }

    private async Task ScrollToBottomAsync()
    {
        try
        {
            await Task.Yield();
            await JSRuntime.InvokeVoidAsync("scrollToBottom", messagesContainer);
        }
        catch { }
    }

    [Inject] private IJSRuntime JSRuntime { get; set; } = default!;

    private async Task OnKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "Enter" && !e.ShiftKey)
        {
            await SendAsync();
        }
    }

    private sealed class ChatMessageViewModel
    {
        public string TableId { get; set; } = string.Empty;
        public string Sender { get; set; } = string.Empty;
        public string Message { get; set; } = string.Empty;
        public DateTime SentAtUtc { get; set; }
        public DateTime SentAtLocal => SentAtUtc.ToLocalTime();
    }
}