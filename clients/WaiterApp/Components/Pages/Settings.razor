@page "/settings"
@using Microsoft.Maui.Storage
@using System.Net.Http.Json
@inject WaiterApp.Services.AuthService Auth
@inject Microsoft.AspNetCore.Components.NavigationManager Navigation

<div class="container py-4">
    <div class="row justify-content-center">
        <div class="col-12 col-lg-6">
            <div class="card shadow-sm">
                <div class="card-body">
                    <h4 class="mb-3">Thi?t l?p h? th?ng</h4>

                    @if (!string.IsNullOrEmpty(statusMessage))
                    {
                        <div class="alert @statusCss">@statusMessage</div>
                    }

                    <div class="mb-3">
                        <label class="form-label fw-semibold">API Base URL</label>
                        <input class="form-control" placeholder="http://10.0.2.2:5075" @bind="apiUrl" />
                        <div class="form-text">S? d?ng 10.0.2.2 cho Android emulator, localhost cho Windows/iOS.</div>
                    </div>

                    <div class="d-flex gap-2 mb-4">
                        <button class="btn btn-primary flex-fill" @onclick="Save" disabled="@string.IsNullOrWhiteSpace(apiUrl)">L?u</button>
                        <button class="btn btn-outline-secondary flex-fill" @onclick="TestAsync" disabled="@isTesting">
                            <span class="spinner-border spinner-border-sm me-1" role="status" hidden="@(!isTesting)"></span>
                            Ki?m tra
                        </button>
                    </div>

                    <div class="border-top pt-3">
                        <button class="btn btn-outline-danger w-100" @onclick="Logout">??ng xu?t</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@code {
    private const string PrefKeyApiBaseUrl = "ApiBaseUrl";
    private string? apiUrl;
    private string? statusMessage;
    private string statusCss = "alert-info";
    private bool isTesting;

    protected override void OnInitialized()
    {
        apiUrl = Preferences.Get(PrefKeyApiBaseUrl, string.Empty);
        if (string.IsNullOrWhiteSpace(apiUrl))
        {
            apiUrl = App.ApiClient.Http.BaseAddress?.ToString();
        }
    }

    private void Save()
    {
        if (string.IsNullOrWhiteSpace(apiUrl))
        {
            ShowStatus("URL không h?p l?.", isError: true);
            return;
        }

        Preferences.Set(PrefKeyApiBaseUrl, apiUrl);
        App.UpdateApiBaseUrl(apiUrl);
        ShowStatus("?ã l?u c?u hình.", isError: false);
    }

    private async Task TestAsync()
    {
        if (string.IsNullOrWhiteSpace(apiUrl))
        {
            ShowStatus("Vui lòng nh?p API URL.", isError: true);
            return;
        }

        try
        {
            isTesting = true;
            using var client = new HttpClient { BaseAddress = new Uri(apiUrl) };
            var resp = await client.GetAsync("api/auth/login");
            ShowStatus(resp.IsSuccessStatusCode
                ? "K?t n?i thành công (endpoint yêu c?u POST)."
                : $"Ph?n h?i: {(int)resp.StatusCode} {resp.ReasonPhrase}", !resp.IsSuccessStatusCode);
        }
        catch (Exception ex)
        {
            ShowStatus("L?i k?t n?i: " + ex.Message, isError: true);
        }
        finally
        {
            isTesting = false;
        }
    }

    private void Logout()
    {
        Auth.Logout();
        Navigation.NavigateTo("/login", forceLoad: true);
    }

    private void ShowStatus(string message, bool isError)
    {
        statusMessage = message;
        statusCss = isError ? "alert-danger" : "alert-success";
    }
}
