@page "/tables/{tableId:guid}/tickets"
@page "/tables/tickets"
@using System.Globalization
@using System.Linq
@using System.Net.Http.Json
@using TableOrdering.Contracts
@inject WaiterApp.Services.ApiClient ApiClient
@inject WaiterApp.Services.KdsRealtimeService Realtime
@inject Microsoft.AspNetCore.Components.NavigationManager Navigation
@implements IAsyncDisposable

<div class="table-ticket-page container py-4">
    <div class="table-ticket-header d-flex align-items-start flex-wrap gap-3 mb-4">
        <div>
            <p class="eyebrow text-uppercase text-muted small mb-1">Floor monitor</p>
            <h2 class="mb-1">Phi?u bàn th?i gian th?c</h2>
            <small class="text-muted">Theo dõi tr?ng thái bàn, t?m tính và ?u tiên thanh toán</small>
        </div>
        <div class="d-flex gap-2 ms-auto flex-wrap">
            <button class="btn btn-outline-secondary" @onclick="BackToTables">
                ? Quay l?i danh sách
            </button>
            <button class="btn btn-dark d-flex align-items-center gap-2" @onclick="LoadAsync" disabled="@loading">
                <span class="spinner-border spinner-border-sm" role="status" hidden="@(!loading)"></span>
                Làm m?i
            </button>
        </div>
    </div>

    <div class="table-ticket-legend d-flex flex-wrap gap-3 mb-3">
        <div class="legend-item"><span class="legend-dot legend-available"></span>Tr?ng</div>
        <div class="legend-item"><span class="legend-dot legend-busy"></span>Có khách</div>
        <div class="legend-item"><span class="legend-dot legend-waiting"></span>Ch? thanh toán</div>
    </div>

    @if (!string.IsNullOrEmpty(alert))
    {
        <div class="alert alert-warning">@alert</div>
    }

    @if (loading && tableCards.Count == 0)
    {
        <div class="alert alert-info">?ang t?i d? li?u bàn...</div>
    }
    else if (tableCards.Count == 0)
    {
        <div class="alert alert-secondary">Ch?a có bàn nào trong h? th?ng.</div>
    }
    else
    {
        <div class="table-ticket-grid">
            @foreach (var card in tableCards)
            {
                var cardCss = $"table-ticket-card{(card.IsWaitingForPayment ? " is-waiting" : string.Empty)}{(card.IsSelected ? " is-selected" : string.Empty)}";
                <div class="@cardCss">
                    <div class="d-flex justify-content-between align-items-start mb-3">
                        <div>
                            <div class="ticket-label text-muted">Bàn</div>
                            <div class="ticket-code">@card.Code</div>
                            <div class="text-muted small">@card.Seats ch?</div>
                        </div>
                        <span class="table-ticket-chip @card.ChipClass">@card.StatusLabel</span>
                    </div>

                    <div class="table-ticket-stats mb-4">
                        <div>
                            <div class="stat-label text-muted">T?ng t?m tính</div>
                            <div class="stat-value">@card.TotalDisplay</div>
                        </div>
                        <div>
                            <div class="stat-label text-muted">Tr?ng thái ??n</div>
                            <div class="stat-secondary">@(card.HasActiveOrder ? card.OrderStatusText : "Ch?a có order")</div>
                        </div>
                    </div>

                    <div class="table-ticket-actions d-flex gap-2">
                        <button class="btn btn-outline-dark w-100" @onclick="() => NavigateToDetail(card.Id)">
                            Qu?n lý bàn
                        </button>
                    </div>
                </div>
            }
        </div>
    }
</div>

@code {
    [Parameter] public Guid? tableId { get; set; }

    private readonly List<TableCardViewModel> tableCards = new();
    private bool loading;
    private string? alert;
    private bool eventsHooked;

    protected override async Task OnParametersSetAsync()
    {
        await LoadAsync();
        await EnsureRealtimeAsync();
    }

    public async ValueTask DisposeAsync()
    {
        if (eventsHooked)
        {
            Realtime.TicketsCreated -= OnTicketsEvent;
            Realtime.TicketChanged -= OnTicketEvent;
        }
        await Task.CompletedTask;
    }

    private async Task LoadAsync()
    {
        loading = true;
        alert = null;
        try
        {
            var tables = await ApiClient.Http.GetFromJsonAsync<List<DiningTableDto>>(WaiterApiEndpoints.Tables.List) ?? new List<DiningTableDto>();
            var tasks = tables.Select(BuildCardAsync).ToArray();
            var cards = await Task.WhenAll(tasks);
            tableCards.Clear();
            tableCards.AddRange(cards.OrderBy(c => c.Code));
        }
        catch (Exception ex)
        {
            alert = ex.Message;
        }
        finally
        {
            loading = false;
        }
    }

    private async Task<TableCardViewModel> BuildCardAsync(DiningTableDto table)
    {
        OrderSnapshot? activeOrder = null;
        try
        {
            var endpoint = WaiterApiEndpoints.Orders.ByTable(table.Id, 1, 1);
            var orders = await ApiClient.Http.GetFromJsonAsync<List<OrderSnapshot>>(endpoint);
            activeOrder = orders?
                .FirstOrDefault(o => !IsFinalized(o.Status))
                ?? orders?.FirstOrDefault();
        }
        catch
        {
            // swallowing per-table errors keeps the board responsive
        }

        return MapToCard(table, activeOrder);
    }

    private TableCardViewModel MapToCard(DiningTableDto table, OrderSnapshot? order)
    {
        var hasOrder = order is not null;
        var waiting = hasOrder && string.Equals(order!.Status, "WaitingForPayment", StringComparison.OrdinalIgnoreCase);
        var statusLabel = !hasOrder ? "Tr?ng" : waiting ? "Ch? thanh toán" : "Có khách";
        var chip = !hasOrder ? "chip-available" : waiting ? "chip-waiting" : "chip-busy";
        var totalText = FormatCurrency(order?.Total, order?.Currency);
        var orderState = hasOrder ? NormalizeStatus(order!.Status) : string.Empty;

        return new TableCardViewModel
        {
            Id = table.Id,
            Code = table.Code,
            Seats = table.Seats,
            StatusLabel = statusLabel,
            ChipClass = chip,
            TotalDisplay = totalText,
            HasActiveOrder = hasOrder,
            IsWaitingForPayment = waiting,
            IsSelected = tableId.HasValue && tableId.Value == table.Id,
            OrderStatusText = orderState
        };
    }

    private async Task EnsureRealtimeAsync()
    {
        if (eventsHooked)
            return;

        eventsHooked = true;
        Realtime.TicketsCreated += OnTicketsEvent;
        Realtime.TicketChanged += OnTicketEvent;
        if (!Realtime.IsConnected)
        {
            try
            {
                await Realtime.StartAsync();
            }
            catch (Exception ex)
            {
                alert = ex.Message;
            }
        }
    }

    private void OnTicketsEvent(WaiterApp.Models.KitchenTicketDto[] payload)
    {
        _ = InvokeAsync(LoadAsync);
    }

    private void OnTicketEvent(WaiterApp.Models.KitchenTicketDto ticket)
    {
        _ = InvokeAsync(LoadAsync);
    }

    private static bool IsFinalized(string? status)
        => string.Equals(status, "Paid", StringComparison.OrdinalIgnoreCase)
           || string.Equals(status, "Cancelled", StringComparison.OrdinalIgnoreCase);

    private static string NormalizeStatus(string? status)
    {
        if (string.IsNullOrWhiteSpace(status)) return "?ang x? lý";
        return status switch
        {
            "Draft" => "?ang ch?n món",
            "Submitted" => "?ã g?i b?p",
            "InProgress" => "?ang ch? bi?n",
            "Ready" => "Món s?n sàng",
            "Served" => "?ã ph?c v?",
            "WaitingForPayment" => "Ch? thu ngân",
            _ => status
        };
    }

    private static string FormatCurrency(decimal? amount, string? currency)
    {
        if (amount is null || amount <= 0)
            return "—";

        var iso = string.IsNullOrWhiteSpace(currency) ? "VND" : currency!.ToUpperInvariant();
        try
        {
            var culture = CultureInfo.GetCultureInfo("vi-VN");
            return string.Format(culture, "{0:N0}", amount) + $" {iso}";
        }
        catch
        {
            return $"{amount.Value:N0} {iso}";
        }
    }

    private void BackToTables()
        => Navigation.NavigateTo("/tables");

    private void NavigateToDetail(Guid id)
        => Navigation.NavigateTo($"/tables/{id}");

    private sealed class OrderSnapshot
    {
        public Guid Id { get; set; }
        public string Status { get; set; } = string.Empty;
        public decimal Total { get; set; }
        public string Currency { get; set; } = "VND";
    }

    private sealed class TableCardViewModel
    {
        public Guid Id { get; init; }
        public string Code { get; init; } = string.Empty;
        public int Seats { get; init; }
        public string StatusLabel { get; init; } = string.Empty;
        public string ChipClass { get; init; } = string.Empty;
        public string TotalDisplay { get; init; } = "—";
        public bool HasActiveOrder { get; init; }
        public bool IsWaitingForPayment { get; init; }
        public bool IsSelected { get; init; }
        public string OrderStatusText { get; init; } = string.Empty;
    }
}
