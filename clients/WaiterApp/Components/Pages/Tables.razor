@page "/"
@page "/tables"
@using System.Net.Http.Json
@using TableOrdering.Contracts
@using WaiterApp.Models
@using WaiterApp.Services
@inject ApiClient ApiClient
@inject NavigationManager Navigation
@inject OrdersRealtimeService Realtime

<div class="px-6 pt-8 pb-24">
    <div class="flex justify-between items-start mb-6">
        <div>
            <p class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-1">Khu vực chính</p>
            <h1 class="text-2xl font-bold text-gray-800 dark:text-white">Sơ đồ bàn</h1>
        </div>
        <button class="p-3 bg-white dark:bg-gray-800 rounded-xl shadow-sm text-gray-600 dark:text-gray-300 active:scale-95 transition-transform"
                @onclick="LoadDataAsync" disabled="@loading">
            <span class="material-icons-round @(loading ? "animate-spin" : "")">sync</span>
        </button>
    </div>

    @if (!string.IsNullOrEmpty(error))
    {
        <div class="p-4 mb-4 rounded-xl bg-red-50 text-red-600 text-sm border border-red-100 flex items-center gap-2">
            <span class="material-icons-round">error_outline</span>
            @error
        </div>
    }

    <div class="grid grid-cols-2 gap-4">
        @if (loading && tables.Count == 0)
        {
            <div class="col-span-2 py-10 text-center text-gray-400 text-sm">Đang tải dữ liệu...</div>
        }
        else
        {
            @foreach (var item in tableViewModels)
            {
                <div @onclick="() => HandleTableClick(item)"
                     class="relative p-4 rounded-2xl shadow-soft transition-all duration-200 active:scale-95 cursor-pointer border-2
                            @(item.HasActiveOrder
                                ? "bg-white dark:bg-gray-800 border-primary/50 shadow-glow"
                                : "bg-white dark:bg-gray-800 border-transparent opacity-75")">

                    @if (item.IsNewOrder)
                    {
                        <div class="absolute -top-3 left-1/2 transform -translate-x-1/2 bg-red-500 text-white text-[10px] font-bold px-3 py-1 rounded-full shadow-md animate-bounce whitespace-nowrap z-10 flex items-center gap-1">
                            <span class="material-icons-round text-[10px]">notifications_active</span>
                            Vừa gửi đơn
                        </div>
                    }

                    <div class="flex justify-between items-start mb-3">
                        <span class="text-lg font-bold text-gray-800 dark:text-white">@item.Table.Code</span>
                        <div class="w-3 h-3 rounded-full @(item.HasActiveOrder ? "bg-primary animate-pulse" : "bg-green-500")"></div>
                    </div>

                    <div class="flex flex-col items-center gap-2 py-2">
                        <div class="w-14 h-14 rounded-full flex items-center justify-center @(item.HasActiveOrder ? "bg-orange-50 text-primary" : "bg-green-50 text-green-500")">
                            <span class="material-icons-round text-3xl">
                                @(item.IsNewOrder ? "notifications_active" : (item.HasActiveOrder ? "soup_kitchen" : "table_restaurant"))
                            </span>
                        </div>
                        <span class="text-xs font-semibold @(item.HasActiveOrder ? "text-primary" : "text-green-600")">
                            @(item.IsNewOrder ? "Khách gọi món!" : (item.HasActiveOrder ? "Đang phục vụ" : "Bàn trống"))
                        </span>
                    </div>

                    <div class="mt-3 pt-3 border-t border-gray-100 dark:border-gray-700 flex justify-between items-center text-xs text-gray-400">
                        <span class="flex items-center gap-1">
                            <span class="material-icons-round text-[12px]">person</span>
                            @item.Table.Seats
                        </span>
                        @if (item.HasActiveOrder)
                        {
                            <span class="font-bold text-primary">@item.OrderTotalDisplay</span>
                        }
                        else
                        {
                            <span class="text-green-500 font-medium">Sẵn sàng</span>
                        }
                    </div>
                </div>
            }
        }
    </div>
</div>

@code {
    private List<TableDto> tables = new();
    private List<OrderSummary> activeOrders = new();
    private List<TableViewModel> tableViewModels = new();
    private bool loading;
    private string? error;

    protected override async Task OnInitializedAsync()
    {
        Realtime.OrderStatusChanged += OnOrderStatusChanged;
        await Realtime.StartAsync();
        await LoadDataAsync();
    }

    public async ValueTask DisposeAsync()
    {
        Realtime.OrderStatusChanged -= OnOrderStatusChanged;
    }

    private void OnOrderStatusChanged(Guid orderId, string status)
        => _ = InvokeAsync(async () => await LoadDataAsync());

    private async Task LoadDataAsync()
    {
        loading = true; error = null;
        try
        {
            var tablesTask = ApiClient.Http.GetFromJsonAsync<List<TableDto>>("api/tables");
            var ordersTask = ApiClient.Http.GetFromJsonAsync<List<OrderSummary>>("api/orders?pageSize=200");

            await Task.WhenAll(tablesTask, ordersTask);

            tables = tablesTask.Result?.OrderBy(t => t.Code).ToList() ?? new();
            var allOrders = ordersTask.Result ?? new();

            // Only keep non-finalized orders (table should be free after Paid/Cancelled)
            activeOrders = allOrders
                .Where(o => o.Status != "Paid" && o.Status != "Cancelled")
                .ToList();

            BuildViewModels();
        }
        catch (Exception ex)
        {
            error = "Lỗi kết nối: " + ex.Message;
        }
        finally
        {
            loading = false;
        }
    }

    private void BuildViewModels()
    {
        tableViewModels = tables.Select(t =>
        {
            var order = activeOrders
                .FirstOrDefault(o => o.TableCode == t.Code || o.TableId == t.Id);

            return new TableViewModel
            {
                Table = t,
                ActiveOrderId = order?.Id,
                HasActiveOrder = order != null,
                IsNewOrder = order?.Status == "Submitted",
                OrderTotalDisplay = order != null ? $"{order.PendingItems} món" : string.Empty
            };
        }).ToList();
    }

    private void HandleTableClick(TableViewModel item)
    {
        if (item.HasActiveOrder && item.ActiveOrderId.HasValue)
        {
            Navigation.NavigateTo($"/orderdetail?orderId={item.ActiveOrderId}");
        }
        else
        {
            // Table is free, could navigate to new order page later
        }
    }

    class TableViewModel
    {
        public TableDto Table { get; set; } = new();
        public Guid? ActiveOrderId { get; set; }
        public bool HasActiveOrder { get; set; }
        public bool IsNewOrder { get; set; }
        public string OrderTotalDisplay { get; set; } = string.Empty;
    }

    class OrderSummary
    {
        public Guid Id { get; set; }
        public Guid TableId { get; set; }
        public string TableCode { get; set; } = string.Empty;
        public string Status { get; set; } = string.Empty;
        public int PendingItems { get; set; }
    }
}