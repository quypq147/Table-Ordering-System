@using AdminWeb.Services.Models
@using System.Text.Json
@model DashboardVm
@{
    ViewData["Title"] = "Tổng quan";
}

<div class="stats mb-4">
    <div class="stat kpi">
        <div class="stat-head">
            <span>Tổng bàn</span>
        </div>
        <div class="stat-value metric" data-metric="TotalTables">0</div>
        <p class="muted">Tổng số bàn trong hệ thống</p>
    </div>

    <div class="stat kpi">
        <div class="stat-head">
            <span>Bàn đang phục vụ</span>
        </div>
        <div class="stat-value metric" data-metric="ActiveTables">0</div>
        <p class="muted">Số bàn có khách hiện tại</p>
    </div>

    <div class="stat kpi">
        <div class="stat-head">
            <span>Đơn hôm nay</span>
        </div>
        <div class="stat-value metric" data-metric="OrdersToday">0</div>
        <p class="muted">Tổng số đơn đã tạo trong ngày</p>
    </div>

    <div class="stat kpi">
        <div class="stat-head">
            <span>Doanh thu hôm nay</span>
        </div>
        <div class="stat-value metric" data-metric="RevenueToday">₫0</div>
        <p class="muted">Tạm tính theo đơn đã ghi nhận</p>
    </div>
</div>

<div class="container my-4">
    <div class="row g-3">
        <div class="col-12 col-md-6">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Doanh Thu (7 ngày)</h5>
                    <canvas id="rev7DaysChart" height="180"></canvas>
                </div>
            </div>
        </div>
        <div class="col-12 col-md-6">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">5 món có số lượng bán cao nhất</h5>
                    <canvas id="topItemsChart" height="180"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="grid grid-cols-1 md:grid-cols-2 gap-4 my-4">
    <div class="panel"><h4>Doanh thu theo giờ</h4><canvas id="revChart" height="140"></canvas></div>
    <div class="panel"><h4>Trạng thái đơn hôm nay</h4><canvas id="stationChart" height="140"></canvas></div>
</div>

<table class="table">
    <thead><tr><th>Mã</th><th>Trạng thái</th><th class="text-end">Tổng</th><th>Lúc</th><th></th></tr></thead>
    <tbody id="recentOrders">
        <tr class="skeleton-row">
            <td colspan="5">
                <div class="skeleton-block skeleton-line-md"></div>
            </td>
        </tr>
    </tbody>
</table>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

<script id="dashboard-data" type="application/json">
    @Html.Raw(ViewBag.DashboardJson ?? "{}")
</script>

<script>
    function renderCharts(model){
        try {
            const revEl = document.getElementById('rev7DaysChart');
            const topEl = document.getElementById('topItemsChart');

            // Kiểm tra thư viện Chart đã load chưa
            if (!revEl || !topEl || !model || typeof Chart === 'undefined') return;

            // BƯỚC 2: Sửa tên biến thành PascalCase (Chữ cái đầu viết hoa)
            // Cũ: model.revenueLast7Days -> Mới: model.RevenueLast7Days
            const rev = Array.isArray(model.RevenueLast7Days) ? model.RevenueLast7Days : [];

            // Cũ: r.date -> Mới: r.Date (hoặc r.date để fallback)
            const revLabels = rev.map(r => (r.Date || r.date || '').toString().slice(5));

            // Cũ: r.total -> Mới: r.Total
            const revData = rev.map(r => Number(r.Total || r.total || 0));

            new Chart(revEl, {
                type: 'bar',
                data: { labels: revLabels, datasets: [{ label: 'Doanh Thu (VND)', data: revData, backgroundColor: 'rgba(54, 162, 235, 0.5)', borderColor: 'rgba(54, 162, 235, 1)', borderWidth: 1 }] },
                options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true } } }
            });

            // BƯỚC 3: Sửa tên biến TopItems thành PascalCase
            // Cũ: model.topItems -> Mới: model.TopItems
            const items = Array.isArray(model.TopItems) ? model.TopItems.slice(0,5) : [];

            // Cũ: i.name -> Mới: i.Name
            const itemLabels = items.map(i => i.Name || i.name || '');

            // Cũ: i.totalQty -> Mới: i.TotalQty
            const itemData = items.map(i => Number(i.TotalQty || i.totalQty || i.qty || 0));

            const colors = ['#FF6384','#36A2EB','#FFCE56','#4BC0C0','#9966FF'];
            new Chart(topEl, { type: 'pie', data: { labels: itemLabels, datasets: [{ data: itemData, backgroundColor: colors, borderWidth: 1 }] }, options: { responsive: true, maintainAspectRatio: false } });
        } catch (e) { console.warn('Chart render error', e); }
    }

    (function(){
        const el = document.getElementById('dashboard-data');
        if (!el) return;
        let model = {};
        try { model = JSON.parse(el.textContent || '{}'); } catch {}

        // Đảm bảo chạy khi window load xong để Chart.js kịp tải
        const init = () => renderCharts(model);
        if (document.readyState === 'complete') init();
        else window.addEventListener('load', init);
    })();
</script>
