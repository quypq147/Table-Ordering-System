@{
    Layout = null;
}
<!doctype html>
<html lang="vi">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Quét QR</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">
    <div class="container py-5">
        <h3 class="mb-3">Quét QR để gọi món</h3>
        <p class="text-muted">Cho phép quyền camera nếu được hỏi.</p>
        <div id="reader" style="width:100%;max-width:480px"></div>
        <div class="mt-3 small text-muted" id="status"></div>
        <hr />
        <p>Nếu không quét được, dùng trang trợ giúp: <a href="/client/qr-help">Hướng dẫn</a></p>
    </div>

    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <script>
        const statusEl = document.getElementById('status');
        function setStatus(t){ statusEl.textContent = t; }

        function go(url){
        try{
        const u = new URL(url);
        // Nếu QR chứa đường dẫn trực tiếp như https://.../c?code=T01 -> chuyển nguyên vẹn
        if (u.pathname.startsWith('/c')) { window.location.href = url; return; }
        // Nếu QR chỉ là mã bàn -> /c?code=...
        window.location.href = '/c?code=' + encodeURIComponent(url);
        } catch {
        // Không phải URL, coi là mã bàn
        window.location.href = '/c?code=' + encodeURIComponent(url);
        }
        }

        function onScanSuccess(decodedText){
        setStatus('Đã quét: ' + decodedText);
        go(decodedText);
        }

        function onScanFailure(){ /* noop để giảm log */ }

        const html5QrCode = new Html5Qrcode("reader");
        Html5Qrcode.getCameras().then(devices => {
        const camId = devices && devices.length ? devices[0].id : null;
        if(!camId){ setStatus('Không tìm thấy camera.'); return; }
        html5QrCode.start(camId, { fps:10, qrbox:250 }, onScanSuccess, onScanFailure)
        .catch(e => setStatus('Không thể khởi động camera: ' + (e?.message||e)));
        }).catch(e => setStatus('Lỗi truy cập camera: ' + (e?.message||e)));
    </script>
</body>
</html>
