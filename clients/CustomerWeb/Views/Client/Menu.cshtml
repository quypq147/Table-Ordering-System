@model CustomerWeb.Models.MenuIndexVm
@{
    Layout = "_Layout";
    ViewData["Title"] = "Thực đơn";
}

<script>
    const TABLE_CODE = '@Model.TableCode';
    const ORDER_ID = '@Model.CurrentCart?.OrderId';
    const ORDER_CODE = '@Model.CurrentCart?.OrderCode';
</script>

<div class="flex flex-1 w-full h-full overflow-hidden">
    
    <aside class="w-20 lg:w-64 bg-white border-r border-gray-200 flex flex-col h-full z-10">
        <div class="h-20 flex items-center justify-between border-b border-gray-50 px-3">
            <div class="flex items-center">
                <div class="w-10 h-10 bg-orange-500 rounded-xl flex items-center justify-center text-white shadow-lg shadow-orange-500/30">
                    <i class="fas fa-utensils"></i>
                </div>
                <span class="ml-3 font-bold text-xl hidden lg:block text-gray-800">Lezato</span>
            </div>
        </div>

        <nav class="flex-1 overflow-y-auto p-3 space-y-2 no-scrollbar">
            @foreach (var cat in Model.Categories)
            {
                bool isActive = cat.Id == Model.CurrentCategoryId;
                string activeClass = isActive ? "bg-orange-500 text-white shadow-md shadow-orange-500/20" : "text-gray-500 hover:bg-orange-50 hover:text-orange-500";
                
                <a href="@Url.Action("Menu", new { tableCode = Model.TableCode, categoryId = cat.Id })" 
                   class="flex items-center p-3 rounded-2xl transition-all duration-300 group @activeClass">
                    <div class="w-10 h-10 rounded-xl bg-white/20 flex items-center justify-center text-lg">
                        <i class="fas fa-hamburger"></i> </div>
                    <span class="ml-3 font-medium hidden lg:block">@cat.Name</span>
                    @if(isActive) { <i class="fas fa-chevron-right ml-auto text-xs hidden lg:block opacity-70"></i> }
                </a>
            }
        </nav>

        <!-- Sidebar footer: Leave Table -->
        <div class="mt-auto border-t p-4">
            <button type="button"
                    onclick="openLeaveConfirm()"
                    class="w-full bg-red-50 text-red-600 hover:bg-red-100 rounded-xl flex items-center justify-center gap-2 py-2 transition">
                <i class="fas fa-sign-out-alt"></i>
                <span>Rời bàn</span>
            </button>
        </div>
    </aside>

    <main class="flex-1 bg-gray-50 h-full overflow-hidden flex flex-col relative">
        <header class="h-20 px-8 flex items-center justify-between bg-white/50 backdrop-blur-sm border-b border-gray-100 sticky top-0 z-10">
            <div>
                <h1 class="text-2xl font-bold text-gray-800">Thực đơn</h1>
                <p class="text-sm text-gray-400">Bàn: <span class="text-orange-500 font-bold">@Model.TableCode</span></p>
            </div>
            <div class="hidden md:flex items-center gap-2">
                <div class="bg-white px-4 py-2 rounded-2xl border border-gray-200 w-64 shadow-sm">
                    <i class="fas fa-search text-gray-400 mt-1 mr-3"></i>
                    <input type="text" placeholder="Tìm món ăn..." class="bg-transparent outline-none text-sm w-full text-gray-700">
                </div>
            </div>
        </header>

        <div class="flex-1 overflow-y-auto p-6">
            <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6 pb-24">
                @foreach (var item in Model.MenuItems)
                {
                    var img = item.AvatarImageUrl ?? item.BackgroundImageUrl ?? "/images/default-food.png";
                    <div class="bg-white p-4 rounded-3xl shadow-[0_2px_20px_rgb(0,0,0,0.04)] hover:shadow-[0_8px_30px_rgba(255,91,36,0.1)] transition-all duration-300 group">
                        <div class="relative mb-4">
                            <img src="@img" 
                                 class="w-full aspect-square object-cover rounded-2xl transform group-hover:scale-[1.02] transition-transform duration-500" 
                                 alt="@item.Name" />
                            
                            <button onclick="addToCart('@item.Id', 1)" 
                                    class="absolute -bottom-4 right-4 w-12 h-12 bg-white text-gray-800 rounded-full shadow-lg flex items-center justify-center hover:bg-orange-500 hover:text-white transition-all duration-300 z-10">
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>
                        
                        <div class="pt-2">
                            <h3 class="font-bold text-gray-800 text-lg mb-1 truncate">@item.Name</h3>
                            <div class="flex items-center justify-between">
                                <span class="text-lg font-bold text-orange-500">@item.Price.ToString("N0")đ</span>
                                <div class="flex text-yellow-400 text-xs gap-1">
                                    <i class="fas fa-star"></i> <span class="text-gray-300">5.0</span>
                                </div>
                            </div>
                        </div>
                    </div>
                }
            </div>
        </div>
    </main>

    <aside id="cart-container" class="hidden md:block h-full relative z-20 transition-all duration-300">
        @if(Model.CurrentCart != null)
        {
            <partial name="_CartPartial" model="Model.CurrentCart" />
        }
    </aside>

    <button onclick="toggleCart()" class="md:hidden fixed bottom-6 right-6 w-16 h-16 bg-orange-500 text-white rounded-full shadow-2xl flex items-center justify-center z-50">
        <i class="fas fa-shopping-basket text-2xl"></i>
        <span class="absolute top-0 right-0 bg-red-500 text-white text-xs font-bold w-6 h-6 rounded-full flex items-center justify-center border-2 border-white">
            @(Model.CurrentCart?.Items.Count ?? 0)
        </span>
    </button>

    <!-- Leave table confirmation modal -->
    <div id="leave-confirm" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-[100]">
        <div class="bg-white rounded-2xl w-11/12 max-w-md shadow-xl p-6">
            <div class="flex items-start gap-3">
                <div class="w-10 h-10 bg-red-100 text-red-600 rounded-xl flex items-center justify-center">
                    <i class="fas fa-exclamation-triangle"></i>
                </div>
                <div class="flex-1">
                    <h2 class="font-bold text-lg text-gray-800">Bạn muốn rời bàn không?</h2>
                    <p class="text-sm text-gray-500 mt-1">Các món trong bàn sẽ không được lưu.</p>
                </div>
            </div>
            <div class="flex gap-3 mt-6">
                <button type="button" onclick="proceedLeave()" class="flex-1 bg-red-500 text-white rounded-xl py-2 hover:bg-red-600 transition">Rời bàn</button>
                <button type="button" onclick="closeLeaveConfirm()" class="flex-1 bg-gray-100 text-gray-700 rounded-xl py-2 hover:bg-gray-200 transition">Hủy</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        function addToCart(menuItemId, qty) {
            const orderId = ORDER_ID;
            if(!orderId){ alert('Chưa có giỏ hàng'); return; }
            $.post('/Client/AddToCart', { 
                orderId: orderId,
                menuItemId: menuItemId, 
                quantity: qty, 
                note: '' 
            }).done(function(html) {
                $('#cart-container').html(html);
            }).fail(function(xhr) {
                alert('Lỗi: ' + xhr.responseText);
            });
        }

        function toggleCart() {
            const cart = document.getElementById('cart-container');
            cart.classList.toggle('hidden');
            cart.classList.toggle('fixed');
            cart.classList.toggle('inset-0');
            cart.classList.toggle('bg-black/50');
        }

        function openLeaveConfirm(){
            const modal = document.getElementById('leave-confirm');
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }
        function closeLeaveConfirm(){
            const modal = document.getElementById('leave-confirm');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        }
        async function proceedLeave(){
            try{
                const resp = await fetch('/Client/LeaveTable', { method: 'POST' });
                if (!resp.ok) throw new Error('Rời bàn thất bại.');
                window.location.href = '/client/qr-help';
            }catch(err){
                alert(err.message || 'Có lỗi xảy ra khi rời bàn.');
            } finally {
                closeLeaveConfirm();
            }
        }

        // Keep old API for potential reuse
        async function leaveTable(){
            openLeaveConfirm();
        }
    </script>
}

