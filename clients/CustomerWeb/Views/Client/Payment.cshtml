@{
    Layout = "~/Views/Shared/_Layout.cshtml";
    Guid orderId = Guid.Empty;
    if (ViewBag.OrderId is Guid g) { orderId = g; }
    else if (ViewBag.OrderId is string s && Guid.TryParse(s, out var gp)) { orderId = gp; }
    ViewData["Title"] = "Thanh toán";
}

<div class="container my-4">
    <h2 class="mb-3">Ch?n ph??ng th?c thanh toán</h2>

    <div class="row g-4">
        <div class="col-md-6">
            <div class="card h-100">
                <div class="card-body">
                    <h5 class="card-title">?? Ti?n m?t</h5>
                    <p class="card-text text-muted">Vui lòng g?i nhân viên ?? thanh toán t?i bàn.</p>
                    <button id="btnCash" class="btn btn-warning">G?i nhân viên</button>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card h-100">
                <div class="card-body">
                    <h5 class="card-title">?? Chuy?n kho?n</h5>
                    <p class="card-text text-muted">Quét mã QR d??i ?ây ?? thanh toán (demo).</p>
                    <div class="text-center my-3">
                        <img src="/images/mock-qr.png" alt="QR Code" style="max-width:240px;width:100%;height:auto;border:1px solid #eee;border-radius:8px;padding:8px;background:#fff;" />
                    </div>
                    <div class="d-grid gap-2">
                        <button id="btnTransfer" class="btn btn-success">?ã chuy?n kho?n</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="alert alert-light d-flex align-items-center gap-2 mt-4 d-none" id="payingOverlay">
        <div class="spinner-border spinner-border-sm" role="status"></div>
        <span>?ang ch? xác nh?n thanh toán...</span>
    </div>
</div>

@section Scripts {
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/8.0.7/signalr.min.js"></script>
    <script>
        const orderId = "@(orderId == Guid.Empty ? "" : orderId.ToString())";
        function showOverlay(show){
            const el = document.getElementById('payingOverlay');
            if (el) el.classList.toggle('d-none', !show);
        }
        async function api(url, opt){
            const resp = await fetch(url, { headers:{'Content-Type':'application/json'}, credentials:'same-origin', ...opt });
            if(!resp.ok){ const t = await resp.text(); throw new Error(t || ('HTTP '+resp.status)); }
            const ct = resp.headers.get('content-type')||'';
            if(ct.includes('application/json')) return await resp.json();
            return await resp.text();
        }
        async function requestCash(){
            showOverlay(true);
            try{
                await api(`/proxy/public/orders/${orderId}/request-cash`, { method:'POST', body:'{}' });
            }catch(e){ /* ignore for demo */ }
        }
        async function mockTransfer(){
            showOverlay(true);
            try{
                await api(`/proxy/public/orders/${orderId}/mock-transfer`, { method:'POST', body:'{}' });
                // immediate redirect on demo
                window.location.href = `/client/order/${orderId}/payment-success`;
            }catch(e){ showOverlay(false); alert(e.message || 'Không th? xác nh?n chuy?n kho?n'); }
        }
        function startSignalR(){
            if (!orderId || typeof signalR === 'undefined') return;
            const conn = new signalR.HubConnectionBuilder()
                .withUrl('/hubs/customer')
                .withAutomaticReconnect()
                .build();
            conn.on('OrderPaid', (payload) => {
                // Redirect to thank-you and clear cart session via backend CloseSession
                showOverlay(false);
                // Clear session cart (server-side): call public proxy close-session
                fetch(`/proxy/public/cart/${orderId}/close-session`, { method:'POST', headers:{'Content-Type':'application/json'}, body:'{}' })
                    .finally(() => { window.location.href = `/client/order/${orderId}/payment-success`; });
            });
            conn.start().then(() => {
                try { conn.invoke('JoinOrderGroup', orderId); } catch {}
            }).catch(() => {});
        }
        document.getElementById('btnCash')?.addEventListener('click', requestCash);
        document.getElementById('btnTransfer')?.addEventListener('click', mockTransfer);
        startSignalR();
    </script>
}
