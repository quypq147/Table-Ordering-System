@{
    Layout = "~/Views/Shared/_Layout.cshtml";
    ViewData["Title"] = "Giỏ hàng";

    // Safe orderId handling: accept Guid or string; fall back to Guid.Empty
    Guid? orderIdVal = null;
    if (ViewBag.OrderId is Guid g) { orderIdVal = g; }
    else if (ViewBag.OrderId is string s && Guid.TryParse(s, out var gp)) { orderIdVal = gp; }

    var orderId = orderIdVal ?? Guid.Empty;
    ViewBag.JsOrderId = orderId;
}

<div class="container py-3">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h3 class="mb-0">Giỏ hàng</h3>
        <div>
            <a id="backMenu" class="btn btn-outline-secondary btn-sm" href="#">Quay lại Menu</a>
            <button id="btnLeave" class="btn btn-outline-danger btn-sm ms-2">Rời bàn</button>
        </div>
    </div>

    <div class="mb-2 small text-muted" id="cartMeta"></div>

    <div class="table-responsive position-relative">
        <div id="pageLoading" class="loading-overlay d-none">
            <div class="loading-box">
                <div class="spinner-border text-primary" role="status" aria-hidden="true"></div>
                <div class="ms-2">Đang xử lý...</div>
            </div>
        </div>
        <table class="table align-middle" id="cartTable">
            <thead>
                <tr>
                    <th>Món</th>
                    <th style="width:220px">Ghi chú</th>
                    <th style="width:140px">Số lượng</th>
                    <th style="width:140px" class="text-end">Đơn giá</th>
                    <th style="width:160px" class="text-end">Thành tiền</th>
                    <th style="width:120px"></th>
                </tr>
            </thead>
            <tbody id="cartBody">
                <tr><td colspan="6" class="text-muted">Đang tải...</td></tr>
            </tbody>
            <tfoot>
                <tr>
                    <td colspan="4" class="text-end text-muted">Tạm tính</td>
                    <td class="text-end" id="subtotal">0</td>
                    <td></td>
                </tr>
                <tr>
                    <td colspan="4" class="text-end text-muted">Phí phục vụ</td>
                    <td class="text-end" id="svc">0</td>
                    <td></td>
                </tr>
                <tr>
                    <td colspan="4" class="text-end text-muted">Thuế</td>
                    <td class="text-end" id="tax">0</td>
                    <td></td>
                </tr>
                <tr class="fw-bold">
                    <td colspan="4" class="text-end">Tổng cộng</td>
                    <td class="text-end fs-5" id="total">0</td>
                    <td></td>
                </tr>
            </tfoot>

        </table>
    </div>

    <div class="d-flex gap-2">
        <button id="btnClear" class="btn btn-outline-danger">Xóa hết</button>
        <button id="btnSubmit" class="btn btn-primary">Gửi đơn hàng</button>
    </div>
</div>

<div class="position-fixed top-0 start-50 translate-middle-x p-3" style="z-index:1080">
    <div id="toast" class="toast align-items-center text-bg-danger border-0" data-bs-delay="2800" data-bs-autohide="true">
        <div class="d-flex">
            <div class="toast-body d-flex align-items-center">
                <span id="toastIcon" class="me-2">⚠️</span>
                <span id="toastMsg">Đã có lỗi</span>
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
    </div>
</div>

@section Scripts {
    <style>
        .loading-overlay {
            position: absolute;
            inset: 0;
            background: rgba(255,255,255,0.7);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .loading-overlay .loading-box {
            display: flex;
            align-items: center;
            padding: .75rem 1rem;
            background: #fff;
            border: 1px solid rgba(0,0,0,.1);
            border-radius: .5rem;
            box-shadow: 0 .25rem .5rem rgba(0,0,0,.1);
        }
    </style>
    <script>
        const orderId = "@ViewBag.JsOrderId";
        let cart = null;
        let statusTimer = null;
        let firstLoadDone = false;

        const statusMap = {
            Draft: 'Đang chọn món',
            Submitted: 'Đã gửi bếp',
            InProgress: 'Đang chế biến',
            Ready: 'Món đã sẵn sàng',
            Served: 'Đã phục vụ',
            Cancelled: 'Đã hủy'
        };

        function toast(message, ok = false) {
            const el = document.getElementById('toast');
            if (!el) return;
            el.classList.toggle('text-bg-success', ok);
            el.classList.toggle('text-bg-danger', !ok);
            const iconEl = document.getElementById('toastIcon');
            const msgEl = document.getElementById('toastMsg');
            if (iconEl) iconEl.textContent = ok ? '✅' : '⚠️';
            if (msgEl) msgEl.textContent = message || (ok ? 'Thành công' : 'Đã có lỗi');
            bootstrap.Toast.getOrCreateInstance(el).show();
        }

        function showPageLoading(show){
            const el = document.getElementById('pageLoading');
            if (!el) return;
            el.classList.toggle('d-none', !show);
        }

        function formatCurrency(n){
            return Number(n || 0).toLocaleString('vi-VN');
        }

        function isDraft(c){
            const s = c && (c.status || c.Status);
            if (typeof s === 'number') return s === 0;
            if (typeof s === 'string') {
                const t = s.trim().toLowerCase();
                if (t === 'draft' || t === '0') return true;
            }
            return !s;
        }

        async function api(url, options = {}){
            const init = { ...options };
            const isForm = init.body instanceof URLSearchParams || init.body instanceof FormData;
            // Only set JSON content-type when sending JSON bodies
            const headers = new Headers(init.headers || {});
            if (!isForm && init.body && !headers.has('Content-Type')) {
                headers.set('Content-Type', 'application/json');
            }
            init.headers = headers;

            const resp = await fetch(url, init);
            const text = await resp.text();
            let data = null;
            try { data = text ? JSON.parse(text) : null; } catch { data = null; }
            if (!resp.ok){
                const msg = (data && (data.title || data.detail || data.message || data.error)) || text || resp.statusText;
                throw new Error(msg);
            }
            return data ?? null;
        }

        async function loadCart(){
            if (!orderId || orderId === '00000000-0000-0000-0000-000000000000'){
                const body = document.getElementById('cartBody');
                if (body) body.innerHTML = '<tr><td colspan="6" class="text-danger">Thiếu Mã đơn hàng.</td></tr>';
                return;
            }
            showPageLoading(!firstLoadDone);
            try {
                cart = await api(`/client/cart/${orderId}/data`);
                renderCart(cart);
                firstLoadDone = true;
            } catch(e){
                const body = document.getElementById('cartBody');
                if (body) body.innerHTML = `<tr><td colspan="6" class="text-danger">${e.message}</td></tr>`;
            } finally {
                showPageLoading(false);
            }
        }

        function renderCart(c){
            if (!c){
                const body = document.getElementById('cartBody');
                if (body) body.innerHTML = '<tr><td colspan="6" class="text-muted">Giỏ hàng trống.</td></tr>';
                return;
            }
            const meta = document.getElementById('cartMeta');
            const status = c.status || c.Status;
            const statusLabel = statusMap[status] || status || 'Đang xử lý';
            const tableCode = c.tableCode || c.TableCode || '';
            if (meta) meta.textContent = `Bàn ${tableCode} · Trạng thái: ${statusLabel}`;

            const items = c.items || c.Items || [];
            const body = document.getElementById('cartBody');
            if (!items || items.length === 0){
                if (body) body.innerHTML = '<tr><td colspan="6" class="text-muted">Chưa có món.</td></tr>';
            } else {
                if (body) body.innerHTML = items.map(it => {
                    const id = it.id || it.Id;
                    const name = it.name || it.Name;
                    const unit = it.unitPrice ?? it.UnitPrice ?? 0;
                    const qty = it.quantity ?? it.Quantity ?? 0;
                    const note = it.note ?? it.Note ?? '';
                    const line = it.lineTotal ?? it.LineTotal ?? (unit * qty);
                    return `
<tr data-item-id="${id}">
    <td>${name}</td>
    <td>
        <input type="text" class="form-control form-control-sm note-input" value="${note || ''}" ${isDraft(c) ? '' : 'disabled'} />
    </td>
    <td>
        <div class="input-group input-group-sm" style="width:120px;">
            <button class="btn btn-outline-secondary btn-dec" ${isDraft(c) ? '' : 'disabled'}>-</button>
            <input type="number" class="form-control text-center qty-input" min="1" value="${qty}" ${isDraft(c) ? '' : 'disabled'} />
            <button class="btn btn-outline-secondary btn-inc" ${isDraft(c) ? '' : 'disabled'}>+</button>
        </div>
    </td>
    <td class="text-end">${formatCurrency(unit)}</td>
    <td class="text-end">${formatCurrency(line)}</td>
    <td class="text-end">
        <button class="btn btn-sm btn-outline-danger btn-remove" ${isDraft(c) ? '' : 'disabled'}>Xóa</button>
    </td>
</tr>`;
                }).join('');
            }

            // totals
            document.getElementById('subtotal').textContent = formatCurrency(c.subtotal ?? c.Subtotal ?? 0);
            document.getElementById('svc').textContent = formatCurrency(c.serviceCharge ?? c.ServiceCharge ?? 0);
            document.getElementById('tax').textContent = formatCurrency(c.tax ?? c.Tax ?? 0);
            document.getElementById('total').textContent = formatCurrency(c.total ?? c.Total ?? 0);

            bindRowEvents();

            // enable/disable actions
            const canEdit = isDraft(c);
            document.getElementById('btnClear').disabled = !canEdit;
            document.getElementById('btnSubmit').disabled = !canEdit;
        }

        function bindRowEvents(){
            // quantity +/-
            document.querySelectorAll('#cartBody tr').forEach(row => {
                const idAttr = row.getAttribute('data-item-id');
                const cartItemId = idAttr ? parseInt(idAttr, 10) : 0;
                const dec = row.querySelector('.btn-dec');
                const inc = row.querySelector('.btn-inc');
                const qtyInput = row.querySelector('.qty-input');
                const noteInput = row.querySelector('.note-input');
                const btnRemove = row.querySelector('.btn-remove');

                dec?.addEventListener('click', async () => {
                    const val = Math.max(1, (parseInt(qtyInput.value, 10) || 1) - 1);
                    await updateItem(cartItemId, val, noteInput?.value || null);
                });
                inc?.addEventListener('click', async () => {
                    const val = (parseInt(qtyInput.value, 10) || 1) + 1;
                    await updateItem(cartItemId, val, noteInput?.value || null);
                });
                qtyInput?.addEventListener('change', async () => {
                    const val = Math.max(1, parseInt(qtyInput.value, 10) || 1);
                    await updateItem(cartItemId, val, noteInput?.value || null);
                });
                noteInput?.addEventListener('change', async () => {
                    const val = Math.max(1, parseInt(qtyInput.value, 10) || 1);
                    await updateItem(cartItemId, val, noteInput?.value || null);
                });
                btnRemove?.addEventListener('click', async () => {
                    await removeItem(cartItemId);
                });
            });
        }

        async function updateItem(cartItemId, quantity, note){
            try{
                showPageLoading(true);
                await api(`/client/cart/${orderId}/items/${cartItemId}`, {
                    method: 'POST',
                    body: new URLSearchParams({ quantity: String(quantity), note: note || '' })
                });
                await loadCart();
            }catch(e){
                toast(e.message, false);
            }finally{
                showPageLoading(false);
            }
        }

        async function removeItem(cartItemId){
            // Backend removal uses menuItemId, need to map from current cart data
            const item = (cart && (cart.items || cart.Items || [])).find(x => (x.id || x.Id) === cartItemId);
            const menuItemId = item ? (item.menuItemId || item.MenuItemId) : null;
            if (!menuItemId){ toast('Không xác định được món để xóa.', false); return; }
            try{
                showPageLoading(true);
                await api(`/client/cart/${orderId}/items/remove`, {
                    method: 'POST',
                    body: new URLSearchParams({ menuItemId: String(menuItemId) })
                });
                await loadCart();
            }catch(e){
                toast(e.message, false);
            }finally{
                showPageLoading(false);
            }
        }

        async function clearCart(){
            if (!confirm('Xóa hết các món trong giỏ?')) return;
            try{
                showPageLoading(true);
                await api(`/client/cart/${orderId}/clear`, { method: 'DELETE' });
                await loadCart();
            }catch(e){
                toast(e.message, false);
            }finally{
                showPageLoading(false);
            }
        }

        async function submitCart(){
            if (!confirm('Gửi đơn hàng tới bếp?')) return;
            try{
                showPageLoading(true);
                await api(`/client/cart/${orderId}/submit`, { method: 'POST', body: new URLSearchParams() });
                await loadCart();
                toast('Đã gửi đơn hàng.', true);
            }catch(e){
                toast(e.message, false);
            }finally{
                showPageLoading(false);
            }
        }

        async function closeSession(){
            if (!confirm('Rời bàn và đóng phiên?')) return;
            try{
                showPageLoading(true);
                await api(`/client/cart/${orderId}/close-session`, { method: 'POST', body: new URLSearchParams() });
                toast('Đã rời bàn.', true);
                setTimeout(()=>{ window.location.href = '/client/qr-help'; }, 800);
            }catch(e){
                toast(e.message, false);
            }finally{
                showPageLoading(false);
            }
        }

        document.getElementById('btnClear')?.addEventListener('click', () => { clearCart(); });
        document.getElementById('btnSubmit')?.addEventListener('click', () => { submitCart(); });
        document.getElementById('btnLeave')?.addEventListener('click', () => { closeSession(); });
        document.getElementById('backMenu')?.addEventListener('click', (e) => {
            e.preventDefault();
            const tbl = (cart && (cart.tableCode || cart.TableCode)) || '';
            if (tbl) {
                       console.log('Navigating back to menu for table:', tbl);
                        window.location.href = `/client/menu?tableCode=`+tbl;
            } else {
                // fallback when cart not loaded
                window.location.href = '/client/qr-help';
            }
        });

        (async () => {
            await loadCart();
            // Poll status to update view if needed (optional every 10s)
            statusTimer = setInterval(async () => {
                await loadCart();
            }, 10000);
        })();
    </script>
}