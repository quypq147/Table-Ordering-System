@{
    Layout = "~/Views/Shared/_Layout.cshtml";
    ViewData["Title"] = "Giỏ hàng";

    // Safe orderId handling: accept Guid or string; fall back to Guid.Empty
    Guid? orderIdVal = null;
    if (ViewBag.OrderId is Guid g) { orderIdVal = g; }
    else if (ViewBag.OrderId is string s && Guid.TryParse(s, out var gp)) { orderIdVal = gp; }
    var orderId = orderIdVal ?? Guid.Empty;
}

<div class="container py-3">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h3 class="mb-0">Giỏ hàng</h3>
        <div>
            <a id="backMenu" class="btn btn-outline-secondary btn-sm" href="#">Quay lại Menu</a>
            <button id="btnLeave" class="btn btn-outline-danger btn-sm ms-2">Rời bàn</button>
        </div>
    </div>

    <div class="mb-2 small text-muted" id="cartMeta"></div>

    <div class="table-responsive position-relative">
        <!-- Inline loading overlay -->
        <div id="pageLoading" class="loading-overlay d-none">
            <div class="loading-box">
                <div class="spinner-border text-primary" role="status" aria-hidden="true"></div>
                <div class="ms-2">Đang xử lý...</div>
            </div>
        </div>
        <table class="table align-middle" id="cartTable">
            <thead>
                <tr>
                    <th>Món</th>
                    <th style="width:220px">Ghi chú</th>
                    <th style="width:140px">Số lượng</th>
                    <th style="width:140px" class="text-end">Đơn giá</th>
                    <th style="width:160px" class="text-end">Thành tiền</th>
                    <th style="width:120px"></th>
                </tr>
            </thead>
            <tbody id="cartBody">
                <tr><td colspan="6" class="text-muted">Đang tải...</td></tr>
            </tbody>
            <tfoot>
                <tr>
                    <td colspan="4" class="text-end text-muted">Tạm tính</td>
                    <td class="text-end" id="subtotal">0</td>
                    <td></td>
                </tr>
                <tr>
                    <td colspan="4" class="text-end text-muted">Phí phục vụ</td>
                    <td class="text-end" id="svc">0</td>
                    <td></td>
                </tr>
                <tr>
                    <td colspan="4" class="text-end text-muted">Thuế</td>
                    <td class="text-end" id="tax">0</td>
                    <td></td>
                </tr>
                <tr class="fw-bold">
                    <td colspan="4" class="text-end">Tổng cộng</td>
                    <td class="text-end fs-5" id="total">0</td>
                    <td></td>
                </tr>
            </tfoot>

        </table>
    </div>

    <div class="d-flex gap-2">
        <button id="btnClear" class="btn btn-outline-danger">Xóa hết</button>
        <button id="btnSubmit" class="btn btn-primary">Gửi đơn hàng</button>
    </div>
</div>

<!-- Toast -->
<div class="position-fixed top-0 start-50 translate-middle-x p-3" style="z-index:1080">
    <div id="toast" class="toast align-items-center text-bg-danger border-0" data-bs-delay="2800" data-bs-autohide="true">
        <div class="d-flex">
            <div class="toast-body d-flex align-items-center">
                <span id="toastIcon" class="me-2">⚠️</span>
                <span id="toastMsg">Đã có lỗi</span>
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
    </div>
</div>

@section Scripts {
    <style>
        .loading-overlay {
            position: absolute;
            inset: 0;
            background: rgba(255,255,255,0.7);
            display: flex;
            align-items: center;
            justify-content: center;
        }

            .loading-overlay .loading-box {
                display: flex;
                align-items: center;
                padding: .75rem 1rem; /* fixed missing space */
                background: #fff;
                border: 1px solid rgba(0,0,0,.1);
                border-radius: .5rem;
                box-shadow: 0 .25rem .5rem rgba(0,0,0,.1);
            }
    </style>
    <script>
        const orderId = "@orderId";
        let cart = null;
        let statusTimer = null;
        let firstLoadDone = false;

        const statusMap = {
            Draft: 'Đang chọn món',
            Submitted: 'Đã gửi bếp',
            InProgress: 'Đang chế biến',
            Ready: 'Món đã sẵn sàng',
            Served: 'Đã phục vụ',
            Cancelled: 'Đã hủy'
        };

        function isDraft(c){
            const s = c && c.status;
            if (typeof s === 'number') return s ===0;
            if (typeof s === 'string') {
                const t = s.trim().toLowerCase();
                if (t === 'draft' || t === '0') return true;
            }
            // Default: if status missing, allow editing (assume draft)
            return !s;
        }
        async function loadCart(){
            const data = await api(`/proxy/public/cart/${orderId}`);

            // Render bảng lớn
            renderCartTable(data.items);

            // Render sidebar
            renderSidebar(data);
        }
        function fmt(x){ return (x||0).toLocaleString() + ' ₫'; }
        function setLoading(show){
            const el = document.getElementById('pageLoading');
            if(!el) return;
            el.classList.toggle('d-none', !show);
        }
        function toast(msg, typeOrOk=false){
            const el = document.getElementById("toast");
            const msgEl = document.getElementById("toastMsg");
            const iconEl = document.getElementById("toastIcon");
            // Backward compat: boolean => success/error
            let type = typeof typeOrOk === 'boolean' ? (typeOrOk ? 'success' : 'danger') : (typeOrOk || 'info');
            const cls = ['text-bg-success','text-bg-danger','text-bg-warning','text-bg-info'];
            el.classList.remove(...cls);
            el.classList.add(`text-bg-${type}`);
            const icons = { success: '✅', danger: '⚠️', warning: '⚠️', info: 'ℹ️' };
            if(iconEl) iconEl.textContent = icons[type] || '';
            msgEl.textContent = msg || (type === 'success' ? 'Thành công' : 'Đã có lỗi');
            bootstrap.Toast.getOrCreateInstance(el).show();
        }
        async function api(url, opt = {}, showLoading = false) {
            try{
                if (showLoading) setLoading(true);
                console.debug('[api] Request:', opt.method || 'GET', url, opt);
                const r = await fetch(url, { headers: { "Content-Type": "application/json" }, credentials: 'same-origin', ...opt });
                const raw = await r.text();
                console.debug('[api] Response raw:', r.status, raw);
                // Determine content-type
                const ct = (r.headers.get('content-type') || '').toLowerCase();

                if (!r.ok) {
                    const serverMsg = raw || r.statusText || `HTTP ${r.status}`;
                    console.error('[api] Error response:', r.status, serverMsg);
                    throw new Error(serverMsg);
                }

                // If response is JSON, parse only when body not empty
                if (ct.includes('application/json')) {
                    if (!raw || !raw.trim()) return null;
                    try {
                        return JSON.parse(raw);
                    } catch (err) {
                        console.warn('[api] JSON parse failed:', err, raw);
                        throw new Error('Invalid JSON response from server');
                    }
                }

                // Otherwise return raw text
                return raw;
            } finally {
                if (showLoading) setLoading(false);
            }
        }
        function renderMeta(){
            const statusText = statusMap[cart?.status] ?? cart?.status ?? '';
            document.getElementById('cartMeta').textContent = cart?.tableCode ? `Bàn ${cart.tableCode} · Trạng thái: ${statusText}` : 'Giỏ hàng';
        }
        function updateBackLink(){
            const backHref = cart?.tableCode ? `/client/menu?tableCode=${encodeURIComponent(cart.tableCode)}` : '#';
            const back = document.getElementById('backMenu');
            back.href = backHref;
            back.classList.toggle('disabled', backHref === '#');
        }
        async function load(showErrorToast = true, withOverlay = false){
            const prevTable = cart && cart.tableCode ? cart.tableCode : null;
            try{
                const data = await api(`/proxy/public/cart/${orderId}`, {}, withOverlay);
                cart = (data && typeof data === 'object') ? data : { items: [] };
            }catch(e){
                cart = { items: [] };
                if (showErrorToast) toast(e.message, 'danger');
            }
            if(!cart.tableCode && prevTable) cart.tableCode = prevTable;
            const items = Array.isArray(cart.items) ? cart.items : [];
            renderMeta();
            document.getElementById('subtotal').textContent = fmt(cart.subtotal ||0);
            document.getElementById('svc').textContent = fmt(cart.serviceCharge ||0);
            document.getElementById('tax').textContent = fmt(cart.tax ||0);
            document.getElementById('total').textContent = fmt(cart.total ||0);
            updateBackLink();
            renderItems(items);
            const hasItems = items.length >0;
            const editable = isDraft(cart);
            document.getElementById('btnSubmit').disabled = !hasItems || !editable;
            document.getElementById('btnClear').disabled = !hasItems || !editable;
            document.getElementById('btnLeave').disabled = !orderId;
            firstLoadDone = true;
        }
        function renderItems(items){
            const body = document.getElementById('cartBody');
            if(!items.length){ body.innerHTML = '<tr><td colspan="6" class="text-muted">Giỏ hàng đang trống.</td></tr>'; return; }
            const editable = isDraft(cart);
            body.innerHTML = items.map(it => `
                <tr data-id="${it.id}" data-menu-id="${it.menuItemId}" data-order-item-id="${Number(it.id) || 0}">
                    <td><div class="fw-semibold">${it.name || ''}</div></td>
                    <td><textarea class="form-control form-control-sm note" rows="1" ${editable ? '' : 'disabled'}>${it.note || ''}</textarea></td>
                    <td>
                        <div class="input-group input-group-sm">
                            <button class="btn btn-outline-secondary btn-dec" type="button" ${editable ? '' : 'disabled'}>-</button>
                            <input type="number" class="form-control text-center qty" min="1" value="${it.quantity ||1}" ${editable ? '' : 'disabled'}>
                            <button class="btn btn-outline-secondary btn-inc" type="button" ${editable ? '' : 'disabled'}>+</button>
                        </div>
                    </td>
                    <td class="text-end">${fmt(it.unitPrice)}</td>
                    <td class="text-end line-total">${fmt(it.lineTotal)}</td>
                    <td class="text-end">
                        <div class="btn-group btn-group-sm">
                            <button class="btn btn-outline-primary btn-save" ${editable ? '' : 'disabled'}>Cập nhật</button>
                            <button class="btn btn-outline-danger btn-del" ${editable ? '' : 'disabled'}>Xóa</button>
                        </div>
                    </td>
                </tr>`).join('');

            if(editable){
                body.querySelectorAll('tr[data-id]').forEach(tr =>{
                    const qtyEl = tr.querySelector('.qty');
                    const noteEl = tr.querySelector('.note');
                    const btnSave = tr.querySelector('.btn-save');
                    const btnInc = tr.querySelector('.btn-inc');
                    const btnDec = tr.querySelector('.btn-dec');
                    const btnDel = tr.querySelector('.btn-del');

                    const orderItemId = parseInt(tr.getAttribute('data-order-item-id') || '0',10);
                    // Only allow inline editing for items that already have an orderItemId (persisted)
                    const rowEditable = orderItemId !== 0;

                    const setRowBusy = (busy)=>{
                        [btnSave, btnInc, btnDec, btnDel, qtyEl, noteEl].forEach(el => {
                            if (el) el.disabled = !!busy;
                        });
                        if (btnSave) {
                            if (busy) {
                                if (!btnSave.dataset.originalText) {
                                    btnSave.dataset.originalText = btnSave.innerHTML;
                                }
                                btnSave.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Đang lưu';
                            } else {
                                btnSave.innerHTML = btnSave.dataset.originalText || 'Cập nhật';
                            }
                        }
                    };

                    // If the item is not yet persisted (orderItemId == 0) disable inc/dec/save to avoid PATCH errors.
                    if(!rowEditable){
                        if(btnSave) btnSave.disabled = true;
                        if(btnInc) btnInc.disabled = true;
                        if(btnDec) btnDec.disabled = true;
                        // Keep delete button enabled: remove will call clear from server (it handles local items)
                    } else {
                        btnInc.onclick = async ()=>{ qtyEl.value = Math.max(1, parseInt(qtyEl.value||'1',10)+1); setRowBusy(true); await save(tr, qtyEl.value, noteEl.value, true).finally(()=> setRowBusy(false)); };
                        btnDec.onclick = async ()=>{ qtyEl.value = Math.max(1, parseInt(qtyEl.value||'1',10)-1); setRowBusy(true); await save(tr, qtyEl.value, noteEl.value, true).finally(()=> setRowBusy(false)); };
                        btnSave.onclick = async ()=>{ setRowBusy(true); await save(tr, qtyEl.value, noteEl.value, true).finally(()=> setRowBusy(false)); };
                    }

                    // Only disable and handle this row's delete button instead of all delete buttons
                    if(btnDel){
                        btnDel.addEventListener('click', async (e)=>{
                            const id = parseInt(tr.getAttribute('data-order-item-id') || '0',10);
                            if(!id) { toast('Thiếu OrderItemId', 'danger'); return; }
                            if(!confirm('Xóa món này khỏi giỏ?')) return;
                            try{
                                btnDel.disabled = true;
                                await removeItem(id, tr);
                            } catch(err){ toast(err.message || err, 'danger'); }
                            finally{ btnDel.disabled = false; }
                        });
                    }
                });
            }
        }
        async function save(rowEl, qty, note, showOverlay=false){
            try{
                qty = Math.max(1, parseInt(qty||'1',10));
                const orderItemId = parseInt(rowEl.getAttribute('data-order-item-id')||'0',10);
                if(!orderItemId){ throw new Error('Thiếu Id dòng món (orderItemId)'); }
                // Patch quantity then note to match backend (proxy translates to backend payloads)
                await api(`/proxy/public/cart/${orderId}/items/${orderItemId}`, { method:'PATCH', body: JSON.stringify({ quantity: qty })}, showOverlay);
                await api(`/proxy/public/cart/${orderId}/items/${orderItemId}/note`, { method:'PATCH', body: JSON.stringify({ note: note || null })}, false);
                await load(false);
                toast('Đã cập nhật', 'success');
            }catch(e){ toast(e.message, 'danger'); }
        }
        // Accepts an optional row element to remove from DOM immediately on success
        async function removeItem(orderItemId, rowEl){
            if(!orderItemId) { throw new Error('Thiếu OrderItemId'); }
            try{
                await api(`/proxy/public/cart/${orderId}/items`, { method:'DELETE', body: JSON.stringify({ orderItemId }) }, true);
                // Update local model and UI
                cart.items = (cart.items || []).filter(x => x.id !== orderItemId);
                // If a row element was provided remove it immediately
                if(rowEl && rowEl.parentNode) rowEl.parentNode.removeChild(rowEl);
                // Refresh totals and meta from server to ensure consistency
                setTimeout(()=> load(false), 200);
                toast('Đã xóa', 'success');
            }catch(e){
                throw e;
            }
        }
        async function clearAll(){
            if(!confirm('Xóa tất cả món trong giỏ?')) return;
            const btn = document.getElementById('btnClear');
            try{
                btn.disabled = true;
                const old = btn.innerHTML;
                btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Đang xóa';
                await api(`/proxy/public/cart/${orderId}/clear`, { method:'POST' }, true);
                if(statusTimer) { clearInterval(statusTimer); statusTimer = null; }
                // Xóa local thay vì chờ load trả về
                cart.items = [];
                renderItems(cart.items);
                document.getElementById('subtotal').textContent = fmt(0);
                document.getElementById('svc').textContent = fmt(0);
                document.getElementById('tax').textContent = fmt(0);
                document.getElementById('total').textContent = fmt(0);
                document.getElementById('btnSubmit').disabled = true;
                document.getElementById('btnClear').disabled = true;
                // Tải lại sau một chút để đồng bộ trạng thái khác (nếu có)
                setTimeout(()=> load(false),300);
                toast('Đã xóa hết', 'success');
            }catch(e){ toast(e.message, 'danger'); }
            finally{ btn.innerHTML = old; btn.disabled = false; }
        }
        async function submit(){
            const items = (cart && Array.isArray(cart.items)) ? cart.items : [];
            if(items.length ===0) { toast('Giỏ hàng đang trống', 'warning'); return; }
            if(!isDraft(cart)){ toast('Đơn hàng đã được gửi / không thể gửi lại', 'warning'); return; }
            if(!confirm('Gửi đơn hàng tới bếp?')) return;
            const btn = document.getElementById('btnSubmit');
            try{
                btn.disabled = true;
                const old = btn.innerHTML;
                btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Đang gửi';
                await api(`/proxy/public/cart/${orderId}/submit`, { method:'POST', body: '{}' }, true);
                toast('Đã gửi đơn hàng!', 'success');
                // Điều hướng sang trang Chi tiết đơn
                window.location.href = `/client/order/${orderId}`;
            }catch(e){ toast(e.message, 'danger'); }
            finally{ btn.innerHTML = old; btn.disabled = false; }
        }
        async function leaveTable(){
            if(!orderId) return;
            if(!confirm('Kết thúc phiên và xoà giỏ hàng (nếu chưa gửi)?')) return;
            const btn = document.getElementById('btnLeave');
            try{
                btn.disabled = true;
                const old = btn.innerHTML;
                btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Đang rời bàn';
                await api(`/proxy/public/cart/${orderId}/close-session`, { method:'POST', body:'{}' }, true);
                toast('Đã rời bàn', 'success');
                setTimeout(()=> window.location.href='/client/qr-help',800);
            }catch(e){ toast(e.message, 'danger'); }
            finally{ btn.innerHTML = old; btn.disabled = false; }
        }
        // Xử lý click quay lại menu ngay cả khi href '#' (chưa load xong)
        document.getElementById('backMenu').addEventListener('click', (e)=>{
            const href = e.currentTarget.getAttribute('href');
            if(href === '#'){
                e.preventDefault();
                if(!cart) { load(false, true); return; }
                if(cart.tableCode){ window.location.href = `/client/menu?tableCode=${encodeURIComponent(cart.tableCode)}`; }
            }
        });
        // Bỏ auto-close khi đóng tab / reload: trước đây gửi beacon tới close-session, đã gỡ bỏ theo yêu cầu.
        document.getElementById('btnLeave').addEventListener('click', leaveTable);
        document.getElementById('btnClear').addEventListener('click', clearAll);
        document.getElementById('btnSubmit').addEventListener('click', submit);
        (async()=>{ try{ await load(true, true); } catch(e){ toast(e.message, 'danger'); } })();
    </script>
}
