@using TableOrdering.Contracts
@model IEnumerable<dynamic>

@{
    ViewData["Title"] = "Bảng bếp (KDS)";
    Layout = "_Layout";
}
<h1>Trạm bếp</h1>

<style>
    .kds-ticket { border-bottom: 1px solid #e9ecef; padding: 10px 0; }
    .kds-ticket__table .table-badge { font-size: 1rem; padding: .35rem .6rem; }
    .kds-ticket__table .order-code { font-size: 1.15rem; font-weight: 700; color: #0d6efd; }
    .kds-ticket__table .order-label { font-size: .75rem; color: #6c757d; }
</style>
<div class="kds-board">
    @if (Model == null || !Model.Any())
    {
        <div class="alert alert-info">Không có phiếu bếp</div>
    }
    else
    {
        foreach (var ticket in Model)
        {
            var status = ticket.Status; 

            <div class="kds-ticket" data-ticket-id="@ticket.Id">
                <div class="kds-ticket__header d-flex justify-content-between align-items-center mb-2">
                    <div class="kds-ticket__table d-flex align-items-baseline gap-2">
                        <span class="badge bg-primary table-badge">@ticket.TableCode</span>
                        <div>
                            <div class="order-label">Mã đơn</div>
                            <div class="order-code">@ticket.OrderCode</div>
                        </div>
                    </div>
                    <div class="kds-ticket__status">
                        <span class="badge badge-status badge-status-@status.ToLowerInvariant()">
                            @status
                        </span>
                    </div>
                </div>

                <div class="kds-ticket__body mb-2">
                    <div class="kds-ticket__item">
                        <div class="fw-semibold">@ticket.ItemName</div>
                        <div>Số lượng: @ticket.Qty</div>
                    </div>
                </div>

                <div class="kds-ticket__footer">
                    <button type="button"
                            class="btn btn-sm btn-outline-primary me-1"
                            onclick="changeTicketStatus('@ticket.Id', 'start')"
                            @(status != "New" ? "disabled" : null)>
                        Bắt đầu
                    </button>

                    <button type="button"
                            class="btn btn-sm btn-outline-success me-1"
                            onclick="changeTicketStatus('@ticket.Id', 'done')"
                            @(status != "New" && status != "InProgress" ? "disabled" : null)>
                        Hoàn thành
                    </button>

                    <button type="button"
                            class="btn btn-sm btn-outline-secondary me-1"
                            onclick="changeTicketStatus('@ticket.Id', 'served')"
                            @(status != "Ready" ? "disabled" : null)>
                        Đã phục vụ
                    </button>

                    <button type="button"
                            class="btn btn-sm btn-outline-danger"
                            onclick="changeTicketStatus('@ticket.Id', 'cancel')"
                            @(status == "Served" || status == "Cancelled" ? "disabled" : null)>
                        Hủy
                    </button>
                </div>
            </div>
        }
    }
</div>

@section Scripts {
    <script>
        async function changeTicketStatus(id, action) {
            if (!id || !action) return;

            if (action === 'cancel') {
                const ok = confirm('Bạn có chắc muốn HỦY phiếu bếp này không?');
                if (!ok) return;
            }

            try {
                // Try to get antiforgery token if present in the DOM
                const tokenEl = document.getElementById('__RequestVerificationToken');
                const headers = {};
                if (tokenEl && tokenEl.value) {
                    headers['RequestVerificationToken'] = tokenEl.value;
                }

                const response = await fetch(`/Board/ChangeStatus?id=${id}&action=${action}`, {
                    method: 'POST',
                    headers: headers
                });

                // Read diagnostic proxy headers if present
                const proxyTo = response.headers.get('x-proxy-to');
                const proxyStatus = response.headers.get('x-proxy-status');

                if (!response.ok) {
                    const text = await response.text();
                    let msg = 'Lỗi cập nhật trạng thái: ' + text;
                    if (proxyTo || proxyStatus) {
                        msg += '\n\nProxy info:';
                        if (proxyTo) msg += '\n  Proxied-To: ' + proxyTo;
                        if (proxyStatus) msg += '\n  Proxy-Status: ' + proxyStatus;
                    }
                    alert(msg);
                    return;
                }

                // Optionally show proxy diagnostics on success (uncomment if needed)
                if (proxyTo || proxyStatus) {
                    console.info('Proxy info', { proxyTo, proxyStatus });
                }

                // Simple refresh to reflect changes
                location.reload();
            } catch (err) {
                console.error(err);
                alert('Không gọi được API KDS. Vui lòng thử lại.');
            }
        }
    </script>
}

