@using TableOrdering.Contracts
@model IEnumerable<KitchenTicketDto>
@* Lưu ý: Gộp các món chung đơn vào 1 phiếu *@

@{
    ViewData["Title"] = "Bếp Chính";

    // Nhóm ticket theo OrderId để hiển thị 1 phiếu / đơn
    var grouped = Model?
        .GroupBy(t => new { t.OrderId, t.OrderCode, t.TableCode })
        .OrderBy(g => g.Min(x => x.CreatedAt))
        .ToList();
}

<div id="tickets-container" class="tickets-container">
    @if (grouped != null)
    {
        foreach (var orderGroup in grouped)
        {
            var first = orderGroup.First();
            string statusClass = "status-new";
            string statusLabel = "MỚI";

            // Chọn trạng thái hiển thị theo ưu tiên từ nhóm (nếu có món đang nấu/đã xong)
            if (orderGroup.Any(x => x.Status == "Ready"))
            {
                statusClass = "status-ready";
                statusLabel = "ĐÃ XONG";
            }
            else if (orderGroup.Any(x => x.Status == "InProgress"))
            {
                statusClass = "status-inprogress";
                statusLabel = "ĐANG NẤU";
            }

            <div class="ticket-card" id="order-@orderGroup.Key.OrderId" data-id="@orderGroup.Key.OrderId" data-created="@first.CreatedAt.ToString("o")">
                <div class="ticket-header @statusClass">
                    <div>
                        <span class="fw-bold fs-5">#@orderGroup.Key.OrderCode</span>
                        <div class="small opacity-75">Bàn: @orderGroup.Key.TableCode</div>
                    </div>
                    <div class="text-end">
                        <div class="timer-badge">00:00</div>
                        <div class="small opacity-75 mt-1">@statusLabel</div>
                    </div>
                </div>

                <div class="ticket-body">
                    @foreach (var ticket in orderGroup)
                    {
                        <div class="order-item">
                            <div class="d-flex justify-content-between">
                                <span>@ticket.ItemName</span>
                                <span class="badge bg-dark rounded-pill">x @ticket.Qty</span>
                            </div>
                        </div>
                    }
                </div>

                <div class="ticket-footer">
                    @* Hiển thị nút thao tác theo từng ticket để giữ chức năng *@
                    <div class="d-flex flex-wrap gap-2">
                        @foreach (var ticket in orderGroup)
                        {
                            if (ticket.Status == "New")
                            {
                                <button onclick="changeStatus('@ticket.Id', 'start')" class="btn btn-outline-primary btn-action">
                                    <i class="fas fa-fire me-2"></i>Bắt đầu nấu (@ticket.ItemName)
                                </button>
                            }
                            else if (ticket.Status == "InProgress")
                            {
                                <button onclick="changeStatus('@ticket.Id', 'done')" class="btn btn-outline-success btn-action">
                                    <i class="fas fa-check me-2"></i>Hoàn tất (@ticket.ItemName)
                                </button>
                            }
                            else if (ticket.Status == "Ready")
                            {
                                <button onclick="changeStatus('@ticket.Id', 'served')" class="btn btn-dark btn-action">
                                    <i class="fas fa-concierge-bell me-2"></i>Đã bê ra (@ticket.ItemName)
                                </button>
                            }
                        }
                    </div>
                </div>
            </div>
        }
    }
</div>

@section Scripts {
    <script>
        function updateTimers() {
            document.querySelectorAll('.ticket-card').forEach(card => {
                const createdStr = card.getAttribute('data-created');
                const created = new Date(createdStr);
                const now = new Date();
                const diffMs = now - created;

                const diffMins = Math.floor(diffMs / 60000);
                const diffSecs = Math.floor((diffMs % 60000) / 1000);

                const timeStr =
                    (diffMins < 10 ? "0" + diffMins : diffMins) + ":" +
                    (diffSecs < 10 ? "0" + diffSecs : diffSecs);

                const badge = card.querySelector('.timer-badge');
                if(badge) {
                    badge.innerText = timeStr;
                    if (diffMins >= 15) {
                        const header = card.querySelector('.ticket-header');
                        if(!header.classList.contains('status-late') && !header.classList.contains('status-ready')) {
                             header.classList.add('status-late');
                        }
                    }
                }
            });
        }

        setInterval(updateTimers, 1000);
        updateTimers();

        async function changeStatus(id, op) {
             try {
                const res = await fetch(`/Board/ChangeStatus?id=${id}&op=${op}`, { method: 'POST' });
                if(res.ok) {
                    location.reload();
                } else {
                    alert("Lỗi cập nhật trạng thái");
                }
            } catch (e) { console.error(e); }
        }
    </script>
}

