@using TableOrdering.Contracts
@model IEnumerable<KitchenTicketDto>
@* Lưu ý: Đảm bảo Model trả về là List<KitchenTicketDto> *@

@{
    ViewData["Title"] = "Kitchen Board";
}

<div id="tickets-container" class="tickets-container">
    @if (Model != null)
    {
        foreach (var ticket in Model)
        {
            // Xác định class màu dựa trên trạng thái (dùng string)
            string statusClass = "status-new";
            string statusLabel = "MỚI";

            if (ticket.Status == "InProgress")
            {
                statusClass = "status-inprogress";
                statusLabel = "ĐANG NẤU";
            }
            else if (ticket.Status == "Ready")
            {
                statusClass = "status-ready";
                statusLabel = "ĐÃ XONG";
            }

            <div class="ticket-card" id="ticket-@ticket.Id" data-id="@ticket.Id" data-created="@ticket.CreatedAt.ToString("o")">
                <div class="ticket-header @statusClass">
                    <div>
                        <span class="fw-bold fs-5">#@ticket.OrderCode</span>
                        <div class="small opacity-75">Bàn: @ticket.TableCode</div>
                    </div>
                    <div class="text-end">
                        <div class="timer-badge">00:00</div>
                        <div class="small opacity-75 mt-1">@statusLabel</div>
                    </div>
                </div>

                <div class="ticket-body">
                    <div class="order-item">
                        <div class="d-flex justify-content-between">
                            <span>@ticket.ItemName</span>
                            <span class="badge bg-dark rounded-pill">x @ticket.Qty</span>
                        </div>
                        @* DTO hiện không có Note *@
                    </div>
                </div>

                <div class="ticket-footer">
                    @if (ticket.Status == "New")
                    {
                        <button onclick="changeStatus('@ticket.Id', 'start')" class="btn btn-outline-primary btn-action">
                            <i class="fas fa-fire me-2"></i>Nấu ngay
                        </button>
                    }
                    else if (ticket.Status == "InProgress")
                    {
                        <button onclick="changeStatus('@ticket.Id', 'done')" class="btn btn-outline-success btn-action">
                            <i class="fas fa-check me-2"></i>Hoàn thành
                        </button>
                    }
                    else if (ticket.Status == "Ready")
                    {
                        <button onclick="changeStatus('@ticket.Id', 'served')" class="btn btn-dark btn-action">
                            <i class="fas fa-concierge-bell me-2"></i>Đã bê ra
                        </button>
                    }
                </div>
            </div>
        }
    }
</div>

@section Scripts {
    <script>
        // Hàm đếm thời gian trôi qua cho từng vé
        function updateTimers() {
            document.querySelectorAll('.ticket-card').forEach(card => {
                const createdStr = card.getAttribute('data-created');
                const created = new Date(createdStr);
                const now = new Date();
                const diffMs = now - created;

                const diffMins = Math.floor(diffMs / 60000);
                const diffSecs = Math.floor((diffMs % 60000) / 1000);

                const timeStr =
                    (diffMins < 10 ? "0" + diffMins : diffMins) + ":" +
                    (diffSecs < 10 ? "0" + diffSecs : diffSecs);

                const badge = card.querySelector('.timer-badge');
                if(badge) {
                    badge.innerText = timeStr;
                    // Nếu quá 15 phút thì đổi màu header thành đỏ (Late)
                    if (diffMins >= 15) {
                        const header = card.querySelector('.ticket-header');
                        if(!header.classList.contains('status-late') && !header.classList.contains('status-ready')) {
                             header.classList.add('status-late');
                        }
                    }
                }
            });
        }

        setInterval(updateTimers, 1000);
        updateTimers();

        // Gọi API thay đổi trạng thái
        async function changeStatus(id, op) {
             try {
                const res = await fetch(`/Board/ChangeStatus?id=${id}&op=${op}`, { method: 'POST' });
                if(res.ok) {
                    location.reload();
                } else {
                    alert("Lỗi cập nhật trạng thái");
                }
            } catch (e) { console.error(e); }
        }
    </script>
}

